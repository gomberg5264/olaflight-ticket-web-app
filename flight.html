<!DOCTYPE html>
<html>

<head>
<title>Olaflight</title>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="js/moment.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
</head>

<body>
    <section class="search-bar">
        <input id="depart">
        <input id="arrive">
        <button id="search">Search flight</button>
    </section>
    <section class="all-flight">
    </section>
    <script>
       // Login credentials
       let root = "http://comp426.cs.unc.edu:3001/";
       let _depart;
       let _arrive;
       const date = "2018-12-21";

       const credentials = {
            username: 'yaxue',
            password: 'yx1123'
        };

        // ######################## P1 -> P2: search ###########################
        $('body').on('click', '#search', function() {
            login(credentials.username, credentials.password).then(function() {
                // login successfully.
                // search flight.
                _depart = $("#depart").val();
                _arrive = $("#arrive").val();
                show_search_result(_depart, _arrive);
            }).fail(function() {
            });
        });

        // ##################### P2 -> P3: select + fill info ##################
        $('body').on('click', '.select-flight', function(){
            let flight_id = $(this).attr("id");
            let body = $('body');

            // clear body, new page.
            body.empty();

            // show selected flight info.
            $.ajax({
                url: root + 'flights/' + flight_id,
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) => {
                    let flight_info = show_one_flight(response, "one");
                    body.append(flight_info);
                }
            });

            // create an instance - flight id + date.
            $.ajax({
                url: root + 'instances',
                type: 'POST',
                xhrFields: { withCredentials: true },
                data: {
                    instance: {
                    flight_id: flight_id,
                    date: date,
                    }
                }, 
                success: (response) => {
                    body.append('instance id: <a id="instance-id">' + response.id + '</a>');
                    console.log("success create instance!!!");
                }
            });

            body.append('Flight id: <div id="flight-id">'+ flight_id + '</div>');
            // read user input of first name, last name, age, gender, seat.
            body.append('First name:<input id="first-name"></input><br>');
            body.append('Last name:<input id="last-name"></input><br>');
            body.append('Age:<input id="age"></input><br>');
            body.append('Gender:<input id="gender"></input><br>');

            // TO DO: SVG SEAT MAP CONNECTED WITH DB. !!!!!!!!!!!!!!!!!!!!!!!
            // TO DO: change to drop down menu.
            body.append('seat row:<input id="seat-row"></input><br>');
            body.append('seat number:<input id="seat-number"></input><br>');

            // row and number via user input.

            body.append('<br><button id="order">Order</button>');

        })

        // ###################### P3: create ticket ############################
        $('body').on('click', '#order', function(){
            let flight_id = $('#flight-id').text();

            // choose seat and create a seat object.
            // require: plane id, row (1, 2, ...), and number ('A', 'B', ...)
            // plane id via flight id.
            $.ajax({
                url: root + 'flights/' + flight_id,
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) => {
                    // create a seat object. 
                    create_seat(response.plane_id,   
                                parseInt($('#seat-row').val()), 
                                $('#seat-number').val());
                }
            });
        })

        // ###################### P4: view ticket ##############################
        $('body').on('click', '.view-ticket', function(){
            console.log($(this).attr("id"));
            let ticket_id = parseInt($(this).attr("id"));
            let body = $('body');

            // clear body, new page.
            body.empty();

            $.ajax({
                url: root + 'tickets/' + ticket_id,
                type: 'GET',
                xhrFields: { withCredentials: true }, 
                success: (response) => {
                    show_ticket(response);
                }
            });
            
        })

        var login = function(username, password) {
            return $.ajax({
                url: root + 'sessions',
                type: 'POST',
                xhrFields: { withCredentials: true },
                data: {
                    user: {
                    username: username,
                    password: password,
                    },
                }
            });
        }

        var show_search_result = function(depart_id, arrive_id) {
            let body = $("body");
            // remove search history.
            body.children(".flight").remove();

            // add new history.
            $.ajax({
                url: root + 'flights',
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) => {
                    // Add filter by depart and arrival.
                    for (let i = 0; i < response.length; i++) {
                        if(response[i].departure_id == depart_id && response[i].arrival_id == arrive_id) {
                            let fdiv = show_one_flight(response[i], "all");
                            body.append(fdiv);
                        }
                    }
                }
            })   
        }

        // input: a flight object.
        var show_one_flight = function(one_flight, num) {
            let fdiv = $('<div class="flight" id="' + one_flight.number + '"></div>');
            // in millisecond.
            let duration = Math.abs(moment(one_flight.departs_at) - moment(one_flight.arrives_at));
            let hour = parseInt(duration / 3600000);
            let minute = Math.round((duration / 3600000 - hour) * 60);

            // duration.
            fdiv.append('<div>duration: ' + hour +'h' + minute + 'min<div>');

            // airline.
            $.ajax({
                url: root + 'airlines',
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) =>  {
                    search_airline(response, one_flight.airline_id);
                }
            })

            var search_airline = function(response, id) {
                for (let prop in response) {
                    if (response[prop].id === id) {
                        fdiv.append('<div>airline id: '  + response[prop].name + '<div>');
                    }
                }
            };
      
            // time. 
            fdiv.append('<div>depart at: ' + (one_flight.departs_at).substring(12, 16) + '<div>');
            fdiv.append('<div>arrive at: ' + (one_flight.arrives_at).substring(12, 16) + '<div>');

            // flight number.
            fdiv.append('<div>flight number: ' + one_flight.number + '<div>');

            // airport.
            $.ajax({
                url: root + 'airports',
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) =>  {
                    search_dep_airport(response, one_flight.departure_id);
                    search_arr_airport(response, one_flight.arrival_id);
                }
            });

            var search_dep_airport = function(response, id) {
                for (let prop in response) {
                    if (response[prop].id === id) {
                        fdiv.append('<div>departure airport: ' + response[prop].name + '<div>');
                    }
                }
            };

            var search_arr_airport = function(response, id) {
                for (let prop in response) {
                    if (response[prop].id === id) {
                        fdiv.append('<div>arrival airport: ' + response[prop].name + '<div>');
                    }
                }
            };

            // price.
            fdiv.append('price: $<div id="price">' + one_flight.info + '<div>');
            
            // select button.
            if (num === "all") {
                fdiv.append('<button class="select-flight" id="' + one_flight.id + '">Select</button>');
            }

            return fdiv;
            }

        var create_seat = function(plane_id, row, number) {
            $.ajax({
                url: root + 'seats',
                type: 'POST',
                xhrFields: { withCredentials: true },
                data: {
                    seat: {
                    plane_id: plane_id,
                    row: row,
                    number: number
                    }
                }, 
                success: (response) => {
                    console.log("success create seat!!!");
                    create_ticket(response);
                }
            });
        }

        var create_ticket = function(response) {
            // create a ticket. 
            // must wait seat create success.
            $.ajax({
                url: root + 'tickets',
                type: 'POST',
                xhrFields: { withCredentials: true },
                data: {
                    ticket: {
                    first_name: $('#first-name').val(),
                    last_name: $('#last-name').val(),
                    age: parseInt($('#age').val()),
                    gender: $('#gender').val(),
                    seat_id: response.id,
                    instance_id: parseInt($('#instance-id').text()),
                    is_purchased: true,
                    price_paid: parseFloat($('#price').text())
                    }
                }, 
                success: (response) => {
                    console.log("success create ticket!!!");
                    $('body').append('<div>Thank you for your order!</div>');
                    $('body').append('<button class="view-ticket" id="' + response.id + '">View ticket</button>');
                }
            });
        }
    
        var show_ticket = function(one_ticket) {
            let body = $('body');
            body.append('First name: <div id="t-first-name">' + one_ticket.first_name + '</div>');
            body.append('Last name: <div id="t-last-name">' + one_ticket.last_name + '</div>');
            body.append('Age: <div id="t-age">' + one_ticket.age+ '</div>');
            body.append('Gender: <div id="t-gender">' + one_ticket.gender + '</div>');
            // seat info via seat id.
            $.ajax({
                url: root + 'seats/' + one_ticket.seat_id,
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) =>  {
                    body.append('Seat row: <div id="t-seat">' + response.row + '</div>');
                    body.append('Seat number: <div id="t-seat">' + response.number + '</div>');
                }
            });
     
            // date and flight info via instance.
            $.ajax({
                url: root + 'instances/' + one_ticket.instance_id,
                type: 'GET',
                xhrFields: { withCredentials: true },
                success: (response) =>  {
                    // date.
                    body.append('Date: <div id="t-seat">' + response.date + '</div>');
                    // flight info.
                    $.ajax({
                        url: root + 'flights/' + response.flight_id,
                        type: 'GET',
                        xhrFields: { withCredentials: true },
                        success: (response) =>  {
                            let flight_info = show_one_flight(response, "one");
                            body.append(flight_info);
                        }
                    });
                }
            });
        }
    </script>
</body>

</html>
